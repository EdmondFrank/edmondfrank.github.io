
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="ja"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>EdmondFrank's 时光足迹</title>
  <meta name="author" content="EdmondFrank">

  
  <meta name="description" content="Java Reflection - Private Fields and Methods Note: This only works when running the code as a standalone Java application, like you do with unit &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://edmondfrank.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="EdmondFrank's 时光足迹" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.cat.net/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_SVG"></script>
  
  

</head>

<body >
  <div id="container">
    <header role="banner"><hgroup>
  <h1><a href="/">EdmondFrank's 时光足迹</a></h1>
  
    <h2>この先は暗い夜道だけかもしれない　それでも信じて進むんだ。星がその道を少しでも照らしてくれるのを。<br>或许前路永夜，即便如此我也要前进，因为星光即使微弱也会我为照亮前途。<br>——《四月は君の嘘》</h2>
  
</hgroup>

</header>
    <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="site:edmondfrank.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
    <div id="main">
      <div id="content">
        <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/11/21/java-reflection/">Java Reflection</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2020-11-21T16:25:03+08:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><h2>Java Reflection - Private Fields and Methods</h2>

<blockquote><p>Note: This only works when running the code as a standalone Java application, like you do with unit tests and regular applications.
if you try to do this inside a Java Applet, you will need to fiddle around with <code>SecurityManager</code>.</p></blockquote>

<h3>Accessing Private Fields</h3>

<p>To access a private field you will need to call <code>Class.getDeclaredFiled(String name)</code> method</p>

<p>The methods <code>Class.getField(String name)</code> only return public fields.</p>

<h4>Example</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.lang.reflect.Field</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">PrivateObject</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">privateString</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">PrivateObject</span><span class="o">(</span><span class="n">String</span> <span class="n">privateString</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">privateString</span> <span class="o">=</span> <span class="n">privateString</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">test</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchFieldException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">PrivateObject</span> <span class="n">privateObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">PrivateObject</span><span class="o">(</span><span class="s">&quot;The Private Value&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Field</span> <span class="n">privateStringField</span> <span class="o">=</span> <span class="n">privateObject</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getDeclaredField</span><span class="o">(</span><span class="s">&quot;privateString&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="n">privateStringField</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">oldFieldValue</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">privateStringField</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">privateObject</span><span class="o">);</span>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;fieldValue: &quot;</span> <span class="o">+</span> <span class="n">oldFieldValue</span><span class="o">);</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">newFieldValue</span> <span class="o">=</span> <span class="n">oldFieldValue</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">&quot;The&quot;</span><span class="o">,</span> <span class="s">&quot;That&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">privateStringField</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">privateObject</span><span class="o">,</span> <span class="n">newFieldValue</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>PS</strong>:
    by calling <code>Field.setAccessible(true)</code> just turn off the access checks for this particular Field instance, for reflection only. Now you can access it even if it is <strong>private/protected</strong> or <strong>package scope</strong>. even if <code>the caller is not part of those scopes</code> But you still can&rsquo;t access the field using normal code which would be disallowed by compiler.</p>

<h3>Accessing Private Methods</h3>

<p>To access a private method you will need to call the <code>Class.getDeclaredMethod(String name, Class[] parameterTypes)</code></p>

<p>The methods <code>Class.getMethod(String name, Class[] parameterTypes)</code>  only return public methods</p>

<h4>Example</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationTargetException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">class</span> <span class="nc">PrivateObject</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="n">privateString</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>    <span class="kd">public</span> <span class="nf">PrivateObject</span><span class="o">(</span><span class="n">String</span> <span class="n">privateString</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">this</span><span class="o">.</span><span class="na">privateString</span> <span class="o">=</span> <span class="n">privateString</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="n">String</span> <span class="nf">getPrivateString</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">privateString</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">test</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">NoSuchMethodException</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">PrivateObject</span> <span class="n">privateObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">PrivateObject</span><span class="o">(</span><span class="s">&quot;The Private Value&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Method</span> <span class="n">privateStringMethod</span> <span class="o">=</span> <span class="n">PrivateObject</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getDeclaredMethod</span><span class="o">(</span><span class="s">&quot;getPrivateString&quot;</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="n">privateStringMethod</span><span class="o">.</span><span class="na">setAccessible</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">returnValue</span> <span class="o">=</span> <span class="o">(</span><span class="n">String</span><span class="o">)</span> <span class="n">privateStringMethod</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">privateObject</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;returnValue = &quot;</span> <span class="o">+</span> <span class="n">returnValue</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IllegalAccessException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InvocationTargetException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


      <footer>
      
      - <a href="/blog/2020/11/21/java-reflection/">Java Reflection</a>
      <time datetime="2020-11-21T16:25:03+08:00" pubdate><span class='month'>Nov</span> <span class='day'>21</span> <span class='year'>2020</span></time>
      
      <span class="categories">posted in <a class='category' href='/blog/categories/java/'>java</a></span>
      
      </footer>
    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/10/26/java-dev-tools-and-debugging-notes/">Java Dev Tools and Debugging Notes</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2020-10-26T23:27:35+08:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><h1>Jave Dev tools and Debugging Notes</h1>

<ol>
<li><a href="#org1b5c54c">Java</a>

<ol>
<li><a href="#org65d3833">Maven</a>

<ol>
<li><a href="#org6c8dc4e">use maven with proxy and skip tests:</a></li>
<li><a href="#orge347d7a">Structure</a></li>
</ol>
</li>
<li><a href="#orgb3fa18c">JShell</a></li>
<li><a href="#orgd240f02">Javap</a></li>
<li><a href="#org6db32e3">Jar Files</a>

<ol>
<li><a href="#orgef3a76f">compile and package as a FAT-JAR</a></li>
<li><a href="#orgc84a88c">differences between &ldquo;java -cp&rdquo; and &ldquo;java -jar&rdquo;</a></li>
</ol>
</li>
<li><a href="#orge743cbc">Debugging</a>

<ol>
<li><a href="#org8d022e6">Exec args:</a></li>
<li><a href="#orgdc3e49d">Jdb</a></li>
</ol>
</li>
</ol>
</li>
</ol>


<p><a id="org1b5c54c"></a></p>

<h1>Java</h1>

<p>Some notes about Java dev tools and debuggers</p>

<p><a id="org65d3833"></a></p>

<h2>Maven</h2>

<p><strong>build lifecycle targets</strong></p>

<ul>
<li><strong>validate</strong>: validate the project is correct and all necessary information is available</li>
<li><strong>compile:</strong> compile the source code of the project</li>
<li><strong>test</strong>: test the compiled source code using a suitable unit testing framework. There tests should not require the code be packaged or deployed</li>
<li><strong>package</strong>: take the compiled code and package it in its distributable format, such as JAR</li>
<li><strong>verify</strong>: run any checks on results of integration tests to ensure quality criteria are met</li>
<li><strong>install</strong>: install the package into the local repository, for use as a dependency in other projects locally</li>
<li><strong>deploy</strong>: done in the build environment, copies the final package to the remote repository for sharing with other developers and projects</li>
</ul>


<p><a id="org6c8dc4e"></a></p>

<h3>use maven with proxy and skip tests:</h3>

<p>-Dmaven.test.skip=true
-Dhttps.proxyHost=127.0.0.1
-Dhttps.proxyPort=1081
-Dhttp.proxyHost=127.0.0.1
-Dhttp.proxyPort=1081</p>

<p><a id="orge347d7a"></a></p>

<h3>Structure</h3>

<ol>
<li>Expected directory structure:

<ul>
<li>Java files are in src/main/java as well as src/test/java.</li>
<li>Resource files are under src/main/resources and src/test/resources.</li>
</ul>
</li>
<li><strong>mvn archetype:generate</strong>: Generates a skeleton of a project based on your inputs (package name, versioning, project name, etc)</li>
<li>Edit pom.xml and set the jdk version there..</li>
<li>mvn package - compile, test, bundle.</li>
</ol>


<p><a id="orgb3fa18c"></a></p>

<h2>JShell</h2>

<p>Java REPL(Read Eval Print Loop) import after Java 9</p>

<ul>
<li><strong>/list</strong> -start - shows modules imported at startup.</li>
<li><strong>/edit <number></strong> - edit that line in a new window.</li>
<li><strong>/set editor &ldquo;vi&rdquo;</strong> - use vi instead of the default graphical edit pad.</li>
<li><strong>/save abc.java</strong> - save current buffer to file.</li>
<li><strong>/load abc.java</strong> - load from file into shell.</li>
<li><strong>/-1</strong> - execute last snippet.</li>
<li><strong>/1</strong> - execute first snippet.</li>
<li><strong>/drop N</strong> - drop Nth snippet.</li>
<li><strong>/vars</strong> - show only variables that were defined in snippets.</li>
<li><strong>/types</strong> - show only classes that were defined in snippets.</li>
</ul>


<p><a id="orgd240f02"></a></p>

<h2>Javap</h2>

<p>javap TestDecompile.class - decompile .class file to human readable format. Does not show content of methods though.
javap -c TestDecompile.class - show jvm bytecode in human readable -form, including methods.</p>

<p><a id="org6db32e3"></a></p>

<h2>Jar Files</h2>

<p>These are zip files that have a META-INF folder with a Manifest.mf file inside.</p>

<p><a id="orgef3a76f"></a></p>

<h3>compile and package as a FAT-JAR</h3>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;build&gt;
   &lt;finalName&gt;indexer-spider&lt;/finalName&gt;
   &lt;plugins&gt;
      &lt;plugin&gt;
         &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
         &lt;artifactId&gt;maven-assembly-plugin&lt;/artifactId&gt;
         &lt;version&gt;2.4.1&lt;/version&gt;
         &lt;configuration&gt;
            &lt;!--  get all project dependencies  --&gt;
            &lt;descriptorRefs&gt;
               &lt;descriptorRef&gt;jar-with-dependencies&lt;/descriptorRef&gt;
            &lt;/descriptorRefs&gt;
            &lt;!--  MainClass in mainfest make a executable jar  --&gt;
            &lt;archive&gt;
               &lt;manifest&gt;
                  &lt;mainClass&gt;org.apache.maven.indexer.examples.BasicUsageExample&lt;/mainClass&gt;
               &lt;/manifest&gt;
            &lt;/archive&gt;
         &lt;/configuration&gt;
         &lt;executions&gt;
            &lt;execution&gt;
               &lt;id&gt;make-assembly&lt;/id&gt;
               &lt;!--  bind to the packaging phase  --&gt;
               &lt;phase&gt;package&lt;/phase&gt;
               &lt;goals&gt;
                  &lt;goal&gt;single&lt;/goal&gt;
               &lt;/goals&gt;
            &lt;/execution&gt;
         &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
         &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
         &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
         &lt;configuration&gt;
            &lt;source&gt;8&lt;/source&gt;
            &lt;target&gt;8&lt;/target&gt;
         &lt;/configuration&gt;
      &lt;/plugin&gt;
   &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>

<p><a id="orgc84a88c"></a></p>

<h3>differences between &ldquo;java -cp&rdquo; and &ldquo;java -jar&rdquo;</h3>

<ul>
<li>There won&rsquo;t be any difference in terms of performance.</li>
<li><strong>java -cp:</strong> must specify the required classes and jar&rsquo;s in the classpath for running a java class file.</li>
<li><strong>java -jar:</strong> jvm finds the class that it needs to run from <strong>/META-INF/MANIFEST.MF</strong> file inside the jar file</li>
</ul>


<p><a id="orge743cbc"></a></p>

<h2>Debugging</h2>

<ul>
<li><strong>jps</strong> - Shows all runnning java processes.</li>
<li><strong>jvisualvm</strong> - If you have it, it shows the java processes on the system with details on threads, profiler etc.</li>
<li><strong>debugging mode</strong> - Use these args to start a process in debugging mode</li>
</ul>


<p><a id="org8d022e6"></a></p>

<h3>Exec args:</h3>

<p><code>-Xagentlib:jdwp=transport=dt_socket,server=y,suspend=y,address=&lt;port&gt;</code></p>

<ul>
<li><strong>agentlib=jdwp</strong> - Load the jdwp agent, for debugging.</li>
<li><strong>transport=dt_socket</strong> - for connecting a debugging client over the network.</li>
<li><strong>server=y</strong> - this one is the server half of the debugging.</li>
<li><strong>suspend=y</strong> - don&rsquo;t start executing until a client debugger attaches.</li>
<li><strong>address=7777</strong> - port we listen on.</li>
</ul>


<p><a id="orgdc3e49d"></a></p>

<h3>Jdb</h3>

<ul>
<li><strong>jdb -attach <port></strong>: attach debug process start with debugging mode.</li>
</ul>

</div>
  
  


      <footer>
      
      - <a href="/blog/2020/10/26/java-dev-tools-and-debugging-notes/">Java Dev tools and Debugging notes</a>
      <time datetime="2020-10-26T23:27:35+08:00" pubdate><span class='month'>Oct</span> <span class='day'>26</span> <span class='year'>2020</span></time>
      
      <span class="categories">posted in <a class='category' href='/blog/categories/java/'>java</a></span>
      
      </footer>
    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/04/09/rails-chang-liang-jia-zai-ji-zhi/">Rails 常量加载机制</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2020-04-09T09:12:45+08:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><h2>0x1 基本介绍</h2>

<p>首先，在编写Rails应用时，代码会预加载：通过约定类定义所在的文件名与类名一致映射，实现自动加载</p>

<p>Rails 通过config.cache_classes参数来设置常见加载的模式，主要有以下两种形式：</p>

<ul>
<li>Kernel#require(一般用于生产环境，只加载一次)</li>
<li>Kernel#load（一般用于开发环境）</li>
</ul>


<p>除了加载的方式不同，在<code>config.cache_classes = false</code>时，Rails还会启用Reloader中间件
在代码发生变更时，通过<code>remove_constant</code>/<code>const_missing</code>等方法实现么常量、模块热替换</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># railties-4.0.13/lib/rails/application.rb:384</span>
</span><span class='line'><span class="k">unless</span> <span class="n">config</span><span class="o">.</span><span class="n">cache_classes</span>
</span><span class='line'>    <span class="n">middleware</span><span class="o">.</span><span class="n">use</span> <span class="o">::</span><span class="no">ActionDispatch</span><span class="o">::</span><span class="no">Reloader</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="n">app</span><span class="o">.</span><span class="n">reload_dependencies?</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>下面，本文逐步解析下Ruby及Rails下的常量加载机制</p>

<h2>0x2 常量刷新机载</h2>

<p>Ruby中常见的常量：</p>

<ul>
<li>模块 module</li>
<li>类 class</li>
<li>自定义常量</li>
</ul>


<p>其中，既然module和class在Ruby中本质就是常量的话，类和模块定义的嵌套创建的命名空间也是常量了</p>

<p>Ruby 的常量嵌套从内向外展开，嵌套通过Module.nesting方法审查</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">X</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Y</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">test</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="no">Module</span><span class="o">.</span><span class="n">nesting</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">X</span><span class="o">::</span><span class="n">Y</span><span class="o">.</span><span class="n">test</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">A</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">B</span>
</span><span class='line'>     <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">test</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="no">Module</span><span class="o">.</span><span class="n">nesting</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">A</span><span class="o">::</span><span class="n">B</span><span class="o">.</span><span class="n">test</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">X::Y</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">A::B</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">test</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="no">Module</span><span class="o">.</span><span class="n">nesting</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">A</span><span class="o">::</span><span class="n">B</span><span class="o">.</span><span class="n">test</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># &gt;&gt;</span>
</span><span class='line'><span class="c1">#[X::Y, X]</span>
</span><span class='line'><span class="c1">#[A::B, A]</span>
</span><span class='line'><span class="c1">#[A::B, X::Y]</span>
</span></code></pre></td></tr></table></div></figure>


<p>从上面的例子看出，嵌套中的类和模块的名称与所在的命名空间没有必然联系</p>

<p>嵌套是解释器维护的一个内部堆栈，根据下述规则修改：
1. 执行 class 关键字后面的定义体时，类对象入栈；执行完毕后出栈。
2. 执行 module 关键字后面的定义体时，模块对象入栈；执行完毕后出栈。
3. 执行 class &lt;&lt; object 打开的单例类时，类对象入栈；执行完毕后出栈。
4. 调用 <code>instance_eval</code> 时如果传入字符串参数，接收者的单例类入栈求值的代码所在的嵌套层次。
5. 调用 <code>class_eval</code> 或 <code>module_eval</code> 时如果传入字符串参数，接收者入栈求值的代码所在的嵌套层次.
6. 顶层代码中由 Kernel#load 解释嵌套是空的，除非调用 load 时把第二个参数设为真值；如果是这样，Ruby 会创建一个匿名模块，将其入栈。</p>

<p>定义类和模块的本质是为常量赋值</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">C</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># =&gt; 本质：在Object中创建一个常量C，并将一个类对象存储进去</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Project</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="err">＃</span> <span class="o">=&gt;</span> <span class="err">本质：</span><span class="no">Project</span> <span class="o">=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ApplicationRecord</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">Admin</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># =&gt; 本质：Admin = Module.new</span>
</span><span class='line'>
</span><span class='line'><span class="no">Admin</span><span class="o">.</span><span class="n">name</span> <span class="c1"># =&gt; &quot;Admin&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>常量赋值的一条特殊规则：如果被赋值的对象是匿名类或模块，Ruby 会把对象的名称设为常量的名称。</p>

<p>自此之后常量和实例发生的事情无关紧要。例如，可以把常量删除，类对象可以赋值给其他常量，或者不再存储于常量中，等等。名称一旦设定就不会再变。</p>

<h2>0x3 常量解析</h2>

<h3>0x31 映射</h3>

<p>当常量存储在模块中，常量就会和类和模块中的常量表关联映射（类似哈希表）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Colors</span>
</span><span class='line'>    <span class="no">RED</span> <span class="o">=</span> <span class="s1">&#39;0xff0000&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>解析模块定义体时，会在Colors常量中的常量表新建一条映射，把"RED"映射到字符串"0xff0000"</p>

<h3>0x32 Ruby下的解析</h3>

<p>相对常量、绝对常量、限定常量</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Billing</span><span class="o">::</span><span class="no">Invoice</span> <span class="c1">#此时，Billing为相对常量，Invoice为限定常量</span>
</span><span class='line'><span class="o">::</span><span class="no">Billing</span><span class="o">::</span><span class="no">Invoice</span> <span class="c1">#此时，Billing为绝对常量（顶层常量）在Object中查找</span>
</span></code></pre></td></tr></table></div></figure>


<p>相对常量解析：
在代码中的特定位置，假如使用 cref 表示嵌套中的第一个元素，如果没有嵌套，则表示 Object。</p>

<ol>
<li>嵌套不为空，在嵌套元素中按元素顺序查找，元素祖先忽略不记</li>
<li>未果，向上回溯，进去cref的祖先链</li>
<li>未果，当cref为module时，进入Object查找常量</li>
<li>未果，在cref上调用const_missing，默认抛出NameError异常，可覆写</li>
</ol>


<p>限定常量解析：
上面例子 Invoice 由 Billing 限定，解析算法如下</p>

<ol>
<li>在 Billing 及其祖先中查找 Invoice 常量</li>
<li>未果，调用 Billing 的const_missing方法，默认抛出NameError异常</li>
</ol>


<p>但Rails 的自动加载机制没有仿照这个算法，查找的起点是要自动加载的常量名称和限定的类或模块对象</p>

<p>如果缺失限定常量，Rails 不会在父级命名空间中查找。</p>

<p>但是有一点要留意：缺失常量时，Rails 不知道它是相对引用还是限定引用。</p>

<p>如果类或模块的父级命名空间中没有缺失的常量，Rails 假定引用的是相对常量。否则是限定常量。</p>

<p>还有在Rails开发环境中，常量时惰性加载的。遇到不存在的常量再触发<code>const_missing</code>使用Rails的自动加载机制</p>

<p>但在生产环境中，预先把所有 autoload 目录下的文件都加载过了。没有触发<code>const_missing</code>使用Ruby本身的常量查找</p>

<h2>0x4 加载机制</h2>

<p>config.cache_classes 设为 false 时，Rails 会重新自动加载常量</p>

<p>在应用运行的过程中，如果相关的逻辑有变，会重新加载代码。为此，Rails 会监控下述文件：</p>

<ul>
<li>config/routes.rb</li>
<li>本地化文件</li>
<li>autoload_paths 中的 Ruby 文件</li>
<li>db/schema.rb 和 db/structure.sql</li>
</ul>


<p>如果这些文件中的内容有变，有个中间件会发现，然后重新加载代码。</p>

<p>主要原理：
1. 先覆写 <code>const_missing</code> 方法，按需去load对应依赖
2. 监听文件变化，自动加载机制会记录自动加载的常量
3. 检测到发生变更，重新加载机制使用 Module#remove_const 方法把它们从相应的类和模块中删除
4. 这样，运行代码时那些常量就变成未知了，从而按需重新加载文件。</p>

<p>但是，因为类之间的依赖极难处理。Rails默认reloader模块经常比较极端，不止重新加载有变化的代码，而是重载一切</p>

<h3>0x41 Ruby Module#autoload 的缺陷</h3>

<p>Module#autoload 是Ruby 提供的惰性常量加载机制，可以遍历应用树调用autoload把文件名和常规的常量名对应起来</p>

<p>但是，Module#autoload 只能使用 require 加载文件，因此无法重新加载。</p>

<p>不仅如此，它使用的还仅是 require 关键字，而不是 Kernel#require 方法。</p>

<p>因此，删除文件后，它无法移除声明。如果使用 Module#remove_const 把常量删除了，不会触发 Module#autoload</p>

<p>综上，在Rails的常量自动加载机制中使用了覆写Module#const_missing 的方式来实现</p>

<p>Rails(ActiveSupport) 中的会根据触发 const_missing 的常量名称来猜测并尝试加载对应的文件, 以加载 Auth::User 为例:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># demo/role.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Demo</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">Role</span>
</span><span class='line'>    <span class="no">User</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># demo/user.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Demo</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>    <span class="s2">&quot;class Demo::User loaded&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># app/models/auth/user.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Auth</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">User</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Demo::Role 找不到 User 常量, 触发 <code>const_missing(const_name)</code>, 此处 <code>const_name == 'User'</code></p>

<p>ActiveSupport 中先拼接出来一个查询的起点 &ldquo;#{Demo::Role.name}::#{const_name}&rdquo;, 即 Demo::Role::User</p>

<p>首先尝试查找 autoload_paths 下的 demo/role/user.rb, 没找到</p>

<p>然后往上走一层, 尝试查找 autoload_paths 下的 demo/user.rb, 找到了</p>
</div>
  
  


      <footer>
      
      - <a href="/blog/2020/04/09/rails-chang-liang-jia-zai-ji-zhi/">Rails 常量加载机制</a>
      <time datetime="2020-04-09T09:12:45+08:00" pubdate><span class='month'>Apr</span> <span class='day'>09</span> <span class='year'>2020</span></time>
      
      <span class="categories">posted in <a class='category' href='/blog/categories/rails/'>rails</a></span>
      
      </footer>
    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/11/29/magit-inside-emacs/">Magit Inside Emacs</a></h1>
    
    
      <div class="post-meta">
        <p class="meta">
          <span class="timestamp">- 








  



<time datetime="2019-11-29T12:50:31+08:00" pubdate data-updated="true"></time> -</span>
          
        </p>
      </div>
    
  </header>


  <div class="entry-content"><h3>基本介绍</h3>

<p><a href="https://magit.vc/">Magit</a> 是 Emacs 下对git的封装，利用Magit可以让你在Emacs中即可完成对git仓库的管理（Emacs果然是一个伪装成编辑器的操作系统）</p>

<p>其次，Magit本不是Emacs的内置插件，使用时需要自己安装；具体的安装方法在Magit的官网上已经有<a href="https://magit.vc/manual/magit/Installing-from-Melpa.html#Installing-from-Melpa">相关教程</a>了，这里我就不再赘述了</p>

<h3>日常使用</h3>

<p>下面主要是列举一些日常开发和git管理中比较常使用的一些功能：</p>

<h4>1. M-x:magit-status(C-x g)</h4>

<p><img src="https://i.loli.net/2019/11/29/45276NGocmKRHdQ.png" alt="magit-status.png" />
该命令就类似于git status（查看项目的当前状态）；但是，在Magit中显示的状态信息会比git status更加丰富
其中包括：HEAD、Tag、未追踪文件、Stash列表、未staged文件、未push文件、最近commit等信息
然后，在相应的条目上回车还可以进行看到更加详细的内容，包括对应文件的修改、具体的commit信息等等</p>

<h4>2. (?) Magit Help</h4>

<p><img src="https://i.loli.net/2019/11/29/CZwBqeMlRDr24oI.png" alt="magit-help.png" />
在magit status buffer中键入？可以提示Magit的功能列表以及其相对应的key bindings，新手通过这样一个帮助列表，就可以找到对应的git功能一一操作试试，一段时间后就可以熟悉整个magit的操作了</p>

<h4>3. （s/S）Stage/Stage all</h4>

<p>Stage命令就类似于git add操作，在你修改了相关的git管理下的文件后，若是还未运行git add时，该文件处于Unstaged的状态
处于Unstaged状态的文件在git commit的时候其变更内容就不会提交；而运行git add [filename] 之后文件就变成Stage状态了，
此时如果再执行git commit，对应的文件变更内容则提交到本地，然后文件状态变更未Unpushed</p>

<h4>4. (u/U) Unstage/Unstage all</h4>

<p>Unstage命令就是Stage命令的反向操作，其对应git reset HEAD [filename]，在Magit中Stage/Unstage不仅能够作用于单个文件、所有的changes，还能作用于某个文件的部分区域上；在magit展开文件的diff时，你还发现在文件差异中用@@符号区分的差异区域，在对应的区域内键入Stage/Unstage命令即可仅仅存在该区域中的变更，然后在commit提交时，也可以单单提交这一部分变更</p>

<p><img src="https://i.loli.net/2019/11/29/J9Zq7wpPkUKn2ts.png" alt="diff.png" /></p>

<h4>5. &copy; Commit</h4>

<p>在magit-status-buffer中键入c键即为最常用的git commit指令，当然后除了最普通的Commit（cc）操作外
Magit还支持许多commit的扩展命令</p>

<table>
<thead>
<tr>
<th> key bindings </th>
<th> command </th>
<th> description                                                      </th>
</tr>
</thead>
<tbody>
<tr>
<td> cc           </td>
<td> Commit  </td>
<td> 最普通的 git commit                                              </td>
</tr>
<tr>
<td> ce           </td>
<td> Extend  </td>
<td> 当前Staged的文件合并到上一次提交中 git commit –amend –no-edit      </td>
</tr>
<tr>
<td> ca           </td>
<td> Amend   </td>
<td> 只修改上次提交的日志   git commit –amend                           </td>
</tr>
</tbody>
</table>


<h4>6. (F) Pull</h4>

<p>Pull命令对应git pull在git管理中用于拉取远程仓库代码，常用的组合命令有以下：</p>

<table>
<thead>
<tr>
<th style="text-align:center;"> key bindings </th>
<th style="text-align:center;"> description                          </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center;"> Fu           </td>
<td style="text-align:center;"> pull from upstream                   </td>
</tr>
<tr>
<td style="text-align:center;"> Fp           </td>
<td style="text-align:center;"> pull from pushremote                 </td>
</tr>
<tr>
<td style="text-align:center;"> Fe           </td>
<td style="text-align:center;"> pull from elsewhere 会引导你从哪pull   </td>
</tr>
</tbody>
</table>


<p>对于Fu 和 Fp来说，upstream是pushremote的上级，这样的场景对应fork分支开发的工作流；
比如User A 有个仓库 Project，User B fork了Project，这样对于User B来说
UserA/Project就是upstream，而pushremote是UserB/Project
另外，在Magit中只有设置了pushremote分支，这样magit status buffer才会显示有哪些变更没有push和pull</p>

<h4>7. (P) Push</h4>

<p>对应git push 命令</p>

<table>
<thead>
<tr>
<th style="text-align:left;"> key bindings </th>
<th style="text-align:left;"> command                </th>
<th style="text-align:left;"> description                </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;"> pu           </td>
<td style="text-align:left;"> push to upstream       </td>
<td style="text-align:left;"> 最普通的git push            </td>
</tr>
<tr>
<td style="text-align:left;"> pe           </td>
<td style="text-align:left;"> push to elsewhere      </td>
<td style="text-align:left;"> 会引导你push到哪个远程分支    </td>
</tr>
<tr>
<td style="text-align:left;"> po           </td>
<td style="text-align:left;"> push another branch to </td>
<td style="text-align:left;"> 会引导你push到哪个分支       </td>
</tr>
<tr>
<td style="text-align:left;"> pT           </td>
<td style="text-align:left;"> push a tag             </td>
<td style="text-align:left;"> push 一个tag标签            </td>
</tr>
<tr>
<td style="text-align:left;"> pt           </td>
<td style="text-align:left;"> push all tag           </td>
<td style="text-align:left;"> push 所有tag标签            </td>
</tr>
</tbody>
</table>


<p>除此之外，上面的key bindings组合还可以添加对应的扩展参数，比如强制push，即p-Fu</p>

<h4>8. (l) Log查看日志</h4>

<p>对应git log，查看git日志记录</p>

<table>
<thead>
<tr>
<th> key bindings </th>
<th> description                  </th>
</tr>
</thead>
<tbody>
<tr>
<td> ll           </td>
<td> 查看当前分支的日志             </td>
</tr>
<tr>
<td> lo           </td>
<td> log other 查看其他分支的日志   </td>
</tr>
</tbody>
</table>


<p>在具体的commit上使用 l 键还可以根据给出的命令组合进一步查看commit提交的详情信息</p>

<h4>9. (a/A) cherry picking</h4>

<p>对应git cherry-pick，选择某一次的commit在当前分支重新commit一次，适用于合并代码但又不想merge整个PR和分支的场景</p>

<h4>10. (z)Stash</h4>

<p>对应git Stash，将临时的未commit的变更内容暂存起来
常用命令有：</p>

<table>
<thead>
<tr>
<th> key bindings </th>
<th> command       </th>
<th> description </th>
</tr>
</thead>
<tbody>
<tr>
<td> zz           </td>
<td> git stash     </td>
<td> 暂存        </td>
</tr>
<tr>
<td> zp           </td>
<td> git stash pop </td>
<td> 恢复        </td>
</tr>
</tbody>
</table>


<p>除此之外，还有一个有意思的用法是，当你希望单单想stash变更文件列表中的一个文件时，可以先将目标文件Stage在index索引区，然后适用 zi 组合暂存index区域，这样就可以实现单一文件的stash功能</p>

<h4>11. (k) Discard/Delete</h4>

<p>对应git中的checkout之类的命令，用作于放弃更改和删除相关的操作，例如，放弃一个Unstage文件的更改、删除一个Stash、删除一个@@区域差异等等</p>

<h4>12. (x) Resetting</h4>

<p>类似git reset命令，放弃最近的n次提交，这n次的提交内容变成staged状态，之后可以进行合并提交或者丢弃
只需要在日志日光标定位到想要丢弃的log,即可回滚到这一次的提交状态</p>

<h4>13. (m) Merge</h4>

<p>对应git中合并分支的操作，常用的组合命令为 mm ，之后会提示选择与哪个分支进行merge</p>

<h4>14. &reg; Rebase</h4>

<p>对应git中的变基操作</p>

<table>
<thead>
<tr>
<th> key bindings </th>
<th> description                        </th>
</tr>
</thead>
<tbody>
<tr>
<td> ru           </td>
<td> rebase on upstream                 </td>
</tr>
<tr>
<td> rp           </td>
<td> rebase on pushremote               </td>
</tr>
<tr>
<td> re           </td>
<td> 会提示你以哪个分支为基点进行rebase     </td>
</tr>
</tbody>
</table>

</div>
  
  


      <footer>
      
      - <a href="/blog/2019/11/29/magit-inside-emacs/">Magit inside Emacs</a>
      <time datetime="2019-11-29T12:50:31+08:00" pubdate><span class='month'>Nov</span> <span class='day'>29</span> <span class='year'>2019</span></time>
      
      <span class="categories">posted in <a class='category' href='/blog/categories/emacs/'>emacs</a></span>
      
      </footer>
    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/archives">Blog Archives</a>
    
  </div><!-- /div.pagination -->
</div><!-- /div.blog-index -->

      </div><!-- /div#content -->
    </div><!-- /div#main -->
  </div><!-- /div.container -->
  <footer><div id="footer-widgets-wrapper">
  <div id="footer-first" class="footer-widget">
    <h3>About Me</h3>
    <section class="about-me">
      
        <img class="icon-image" src="https://avatars0.githubusercontent.com/u/13914416?s=240" alt="icon_image">
      
      <div>
        <ul>
          
            <li>GitHub: <a href="https://github.com/EdmondFrank">@EdmondFrank</a></li>
          
          
            <li>Twitter: <a href="https://twitter.com/EdmondFrank4">@EdmondFrank4</a></li>
          
            <li>Blog: <a href="https://edmondfrank.github.io">https://edmondfrank.github.io</a></li>
        </ul>
        <p>
          この町、冗談と気まぐれと偶然でてきっているらしい。
        </p>
      </div>
    </section>
  </div><!-- /div#footer-second -->

  <div id="footer-second" class="footer-widget">
    <h3>Recent Posts</h3>
    <section id="hatena-popular" class="hatena-bookmark">
      <script language="javascript" type="text/javascript" src="https://b.hatena.ne.jp/js/widget.js" charset="utf-8"></script>
      <script language="javascript" type="text/javascript">
        Hatena.BookmarkWidget.url   = "https://edmondfrank.github.io";
        Hatena.BookmarkWidget.title = "Recent Posts";
        Hatena.BookmarkWidget.sort  = "hot";
        Hatena.BookmarkWidget.width = 0;
        Hatena.BookmarkWidget.num   = 10;
        Hatena.BookmarkWidget.theme = "notheme";
        Hatena.BookmarkWidget.load();
      </script>
    </section>
  </div><!-- /div#footer-second -->

  <div id="footer-third" class="footer-widget">
    <h3>Popular Posts</h3>
    <section id="hatena-popular" class="hatena-bookmark">
      <script language="javascript" type="text/javascript" src="https://b.hatena.ne.jp/js/widget.js" charset="utf-8"></script>
      <script language="javascript" type="text/javascript">
        Hatena.BookmarkWidget.url   = "https://edmondfrank.github.io";
        Hatena.BookmarkWidget.title = "Popular Posts";
        Hatena.BookmarkWidget.sort  = "count";
        Hatena.BookmarkWidget.width = 0;
        Hatena.BookmarkWidget.num   = 10;
        Hatena.BookmarkWidget.theme = "notheme";
        Hatena.BookmarkWidget.load();
      </script>
    </section>
  </div><!-- /div#footer-third -->
</div><!-- /div#footer-widgets-wrapper -->

<div id="credit" role="contentinfo">
  <p>
    Copyright &copy; 2022 - <a href="https://github.com/EdmondFrank/">EdmondFrank</a> -
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
  </p>
</div>

</footer>
  










  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
